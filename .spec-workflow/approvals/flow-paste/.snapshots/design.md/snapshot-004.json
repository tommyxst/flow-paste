{
  "id": "snapshot_1766068315156_y7pn34fpp",
  "approvalId": "approval_1766068303471_17a2j5axw",
  "approvalTitle": "Updated Design (IPC Events, Window Behavior Spec)",
  "version": 4,
  "timestamp": "2025-12-18T14:31:55.156Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Design Document - FlowPaste (MVP v1.0)\n\n## Overview\n\nFlowPaste 是基于 Tauri 框架的跨平台桌面应用，采用 Rust 后端 + Vue 前端架构。系统核心是一个 Spotlight 风格的悬浮面板，通过全局快捷键唤起，提供剪贴板内容的智能处理能力。\n\n**技术栈：**\n- **Backend:** Rust (Tauri 2.x)\n- **Frontend:** Vue 3 + TypeScript + TailwindCSS\n- **Storage:** SQLite (via rusqlite) + OS Keychain\n- **AI Integration:** OpenAI-compatible API + Ollama\n\n## Architecture\n\n### High-Level Architecture\n\n```mermaid\ngraph TB\n    subgraph \"Frontend (Vue 3)\"\n        UI[FloatingPanel UI]\n        State[Pinia Store]\n        Composables[Composables]\n    end\n\n    subgraph \"Tauri IPC Bridge\"\n        IPC[invoke/listen API]\n    end\n\n    subgraph \"Backend (Rust)\"\n        CMD[Tauri Commands]\n\n        subgraph \"Core Modules\"\n            CB[Clipboard Module]\n            HK[Hotkey Module]\n            AI[AI Engine]\n            PII[Privacy Shield]\n            REG[Regex Engine]\n        end\n\n        subgraph \"Infrastructure\"\n            DB[(SQLite)]\n            KC[Keychain]\n            CFG[Config Manager]\n        end\n    end\n\n    subgraph \"External\"\n        OL[Ollama Local]\n        CLOUD[Cloud AI API]\n    end\n\n    UI --> State\n    State --> Composables\n    Composables --> IPC\n    IPC --> CMD\n    CMD --> CB\n    CMD --> HK\n    CMD --> AI\n    CMD --> PII\n    CMD --> REG\n    AI --> OL\n    AI --> CLOUD\n    PII --> REG\n    CMD --> DB\n    CMD --> KC\n    CMD --> CFG\n```\n\n### Modular Design Principles\n\n- **Single File Responsibility:** 每个模块文件只负责一个核心功能\n- **Component Isolation:** UI 组件细粒度拆分，便于测试和复用\n- **Service Layer Separation:** Rust 后端分为 Commands / Services / Infrastructure 三层\n- **Utility Modularity:** 正则规则、PII 模式等作为独立配置模块\n\n### IPC Event Specification\n\nFrontend 与 Backend 之间的事件通信遵循统一命名规范：\n\n| Event Name | Direction | Payload | Description |\n|:-----------|:----------|:--------|:------------|\n| `panel:toggle` | Backend → Frontend | `{ visible: boolean }` | 热键触发面板显示/隐藏 |\n| `panel:hide` | Frontend → Backend | `null` | 请求隐藏面板 |\n| `ai:chunk` | Backend → Frontend | `{ content: string, done: false }` | AI 流式响应片段 |\n| `ai:done` | Backend → Frontend | `{ content: string, done: true }` | AI 响应完成 |\n| `ai:error` | Backend → Frontend | `{ code: string, message: string }` | AI 请求错误 |\n| `ai:cancel` | Frontend → Backend | `{ request_id: string }` | 取消 AI 请求 |\n| `clipboard:changed` | Backend → Frontend | `{ has_text: boolean }` | 剪贴板内容变化 |\n\n**命名约定:**\n- 使用 `module:action` 格式\n- 模块名: `panel`, `ai`, `clipboard`, `config`\n- 动作名: `toggle`, `chunk`, `done`, `error`, `cancel`, `changed`\n\n### Window Behavior Specification\n\nFloatingPanel 窗口遵循以下行为规范：\n\n| Trigger | Behavior | Notes |\n|:--------|:---------|:------|\n| 热键按下 | 显示面板（居中） | 自动聚焦输入框 |\n| 热键再次按下 | 隐藏面板 | 保留当前状态 |\n| Esc 键 | 隐藏面板 | 取消当前操作 |\n| 点击面板外部 | 隐藏面板 | 失焦自动隐藏 |\n| AI 处理中失焦 | 后台继续处理 | 完成后发送系统通知 |\n| Enter 确认 | 粘贴并隐藏 | 结果上屏 |\n\n**防抖机制:**\n- 显示/隐藏切换间隔最小 100ms\n- 避免快速重复热键导致的闪烁\n\n## Components and Interfaces\n\n### Backend Components (Rust)\n\n#### 1. Clipboard Module (`src-tauri/src/clipboard/`)\n\n- **Purpose:** 系统剪贴板读写操作\n- **Interfaces:**\n  ```rust\n  pub fn read_clipboard() -> Result<String, ClipboardError>\n  pub fn write_clipboard(content: &str) -> Result<(), ClipboardError>\n  ```\n- **Dependencies:** `arboard` crate\n- **Reuses:** None (基础模块)\n\n#### 2. Hotkey Module (`src-tauri/src/hotkey/`)\n\n- **Purpose:** 全局快捷键注册与监听\n- **Interfaces:**\n  ```rust\n  pub fn register_hotkey(keys: &str) -> Result<(), HotkeyError>\n  pub fn unregister_hotkey() -> Result<(), HotkeyError>\n  pub fn get_current_hotkey() -> String\n  ```\n- **Dependencies:** Tauri global-shortcut plugin\n- **Reuses:** Config Manager (读取用户配置)\n\n#### 3. AI Engine (`src-tauri/src/ai/`)\n\n- **Purpose:** AI 模型调用统一接口\n- **Interfaces:**\n  ```rust\n  pub async fn complete(prompt: &str, config: &AIConfig) -> Result<StreamingResponse, AIError>\n  pub async fn detect_intent(text: &str) -> Result<Vec<ActionChip>, AIError>\n  pub fn list_local_models() -> Result<Vec<ModelInfo>, AIError>\n  ```\n- **Dependencies:** `reqwest`, `tokio`, `serde_json`\n- **Reuses:** Config Manager, Privacy Shield (预处理)\n\n#### 4. Privacy Shield (`src-tauri/src/privacy/`)\n\n- **Purpose:** PII 检测、脱敏与还原\n- **Interfaces:**\n  ```rust\n  pub fn scan_pii(text: &str) -> PIIScanResult\n  pub fn mask_pii(text: &str, scan: &PIIScanResult) -> (String, MaskMapping)\n  pub fn restore_pii(text: &str, mapping: &MaskMapping) -> String\n  ```\n- **Dependencies:** `regex` crate\n- **Reuses:** Regex Engine (PII patterns)\n\n#### 5. Regex Engine (`src-tauri/src/regex/`)\n\n- **Purpose:** 本地文本处理规则\n- **Interfaces:**\n  ```rust\n  pub fn apply_rule(text: &str, rule: &Rule) -> String\n  pub fn get_builtin_rules() -> Vec<Rule>\n  ```\n- **Dependencies:** `regex` crate\n- **Reuses:** None (基础模块)\n\n#### 6. Config Manager (`src-tauri/src/config/`)\n\n- **Purpose:** 用户配置管理\n- **Interfaces:**\n  ```rust\n  pub fn load_config() -> Result<AppConfig, ConfigError>\n  pub fn save_config(config: &AppConfig) -> Result<(), ConfigError>\n  pub fn get_api_key(provider: &str) -> Result<String, KeychainError>\n  pub fn set_api_key(provider: &str, key: &str) -> Result<(), KeychainError>\n  ```\n- **Dependencies:** `rusqlite`, `keyring` crate\n- **Reuses:** None (基础模块)\n\n### Frontend Components (Vue 3)\n\n#### 1. FloatingPanel (`src/components/FloatingPanel.vue`)\n\n- **Purpose:** 主界面容器，Spotlight 风格悬浮窗\n- **Props:** None (根组件)\n- **State:** 通过 Pinia store 管理 `panelState`, `clipboardContent`, `processingStatus`\n- **Dependencies:** CommandInput, Preview, ActionChips, PrivacyIndicator\n\n#### 2. CommandInput (`src/components/CommandInput.vue`)\n\n- **Purpose:** 顶部输入框，支持自然语言指令\n- **Props:**\n  ```typescript\n  defineProps<{\n    placeholder?: string\n    disabled?: boolean\n  }>()\n\n  defineEmits<{\n    submit: [command: string]\n  }>()\n  ```\n- **Dependencies:** None\n\n#### 3. Preview (`src/components/Preview.vue`)\n\n- **Purpose:** 剪贴板内容预览 + 处理结果展示\n- **Props:**\n  ```typescript\n  defineProps<{\n    content: string\n    mode: 'preview' | 'result' | 'streaming'\n    highlight?: boolean\n  }>()\n  ```\n- **Dependencies:** `shiki` (代码高亮)\n\n#### 4. ActionChips (`src/components/ActionChips.vue`)\n\n- **Purpose:** AI 推荐操作按钮组\n- **Props:**\n  ```typescript\n  defineProps<{\n    chips: ActionChip[]\n    selectedIndex?: number\n  }>()\n\n  defineEmits<{\n    select: [chip: ActionChip]\n  }>()\n  ```\n- **Dependencies:** None\n\n#### 5. PrivacyIndicator (`src/components/PrivacyIndicator.vue`)\n\n- **Purpose:** 隐私盾状态指示器\n- **Props:**\n  ```typescript\n  defineProps<{\n    status: 'local' | 'cloud-safe' | 'cloud-masked'\n    maskedCount?: number\n  }>()\n  ```\n- **Dependencies:** None\n\n### State Management (Pinia)\n\n```typescript\n// src/stores/app.ts\nexport const useAppStore = defineStore('app', () => {\n  // Panel State\n  const isVisible = ref(false)\n  const panelMode = ref<'idle' | 'preview' | 'processing' | 'result'>('idle')\n\n  // Content\n  const clipboardContent = ref('')\n  const processedContent = ref('')\n  const streamingContent = ref('')\n\n  // AI\n  const actionChips = ref<ActionChip[]>([])\n  const selectedChipIndex = ref(0)\n\n  // Privacy\n  const privacyStatus = ref<PrivacyStatus>({ type: 'local' })\n  const maskedMapping = ref<Record<string, string>>({})\n\n  // Actions\n  async function showPanel() { /* ... */ }\n  async function hidePanel() { /* ... */ }\n  async function processWithRule(ruleId: string) { /* ... */ }\n  async function processWithAI(prompt: string) { /* ... */ }\n  async function confirmPaste() { /* ... */ }\n\n  return {\n    isVisible, panelMode,\n    clipboardContent, processedContent, streamingContent,\n    actionChips, selectedChipIndex,\n    privacyStatus, maskedMapping,\n    showPanel, hidePanel, processWithRule, processWithAI, confirmPaste\n  }\n})\n```\n\n## Data Models\n\n### AppConfig (SQLite)\n\n```sql\nCREATE TABLE config (\n  key TEXT PRIMARY KEY,\n  value TEXT NOT NULL,\n  updated_at INTEGER NOT NULL\n);\n\n-- Example keys:\n-- 'hotkey' -> 'CommandOrControl+Shift+V'\n-- 'ai_provider' -> 'openai' | 'ollama'\n-- 'ollama_base_url' -> 'http://localhost:11434'\n-- 'openai_base_url' -> 'https://api.openai.com/v1'\n-- 'model_name' -> 'gpt-4o-mini'\n-- 'theme' -> 'system' | 'light' | 'dark'\n```\n\n### Rule\n\n```rust\npub struct Rule {\n    pub id: String,\n    pub name: String,\n    pub description: String,\n    pub pattern: String,       // Regex pattern\n    pub replacement: String,   // Replacement template\n    pub is_builtin: bool,\n}\n```\n\n### ActionChip\n\n```rust\npub struct ActionChip {\n    pub id: String,\n    pub label: String,\n    pub action_type: ActionType,  // LocalRule | AIPrompt\n    pub payload: String,          // rule_id or prompt template\n    pub shortcut: Option<char>,   // '1', '2', '3'\n}\n```\n\n### PIIScanResult\n\n```rust\npub struct PIIScanResult {\n    pub has_pii: bool,\n    pub items: Vec<PIIItem>,\n}\n\npub struct PIIItem {\n    pub pii_type: PIIType,    // Phone, Email, IDCard, BankCard, IP, APIKey\n    pub value: String,\n    pub start: usize,\n    pub end: usize,\n}\n\npub struct MaskMapping {\n    pub mappings: HashMap<String, String>,  // {{PHONE_01}} -> 13800138000\n}\n```\n\n### AIConfig\n\n```rust\npub struct AIConfig {\n    pub provider: AIProvider,     // OpenAI | Ollama\n    pub base_url: String,\n    pub model: String,\n    pub api_key: Option<String>,  // From keychain, None for Ollama\n    pub max_tokens: u32,\n    pub temperature: f32,\n}\n```\n\n## Error Handling\n\n### Error Scenarios\n\n1. **Clipboard Access Failure**\n   - **Handling:** 返回 `ClipboardError::AccessDenied`，前端显示权限提示\n   - **User Impact:** 面板显示 \"无法访问剪贴板，请检查权限设置\"\n\n2. **API Key Missing/Invalid**\n   - **Handling:** 返回 `AIError::AuthenticationFailed`\n   - **User Impact:** 面板显示 \"API 密钥无效，请在设置中配置\"，提供跳转按钮\n\n3. **Network Timeout**\n   - **Handling:** 5s 超时后返回 `AIError::Timeout`\n   - **User Impact:** 面板轻微抖动，显示 \"请求超时，点击重试\"\n\n4. **Ollama Not Running**\n   - **Handling:** 连接失败返回 `AIError::ConnectionRefused`\n   - **User Impact:** 显示 \"无法连接本地模型，请确认 Ollama 已启动\"\n\n5. **PII Restoration Failure**\n   - **Handling:** 占位符未找到时保留原文，记录 warning\n   - **User Impact:** 结果中可能显示 `{{TYPE_ID}}` 占位符，提示用户检查\n\n### Error Response Format\n\n```rust\n#[derive(Serialize)]\npub struct ErrorResponse {\n    pub code: String,\n    pub message: String,\n    pub recoverable: bool,\n    pub action: Option<ErrorAction>,  // Retry | Settings | Dismiss\n}\n```\n\n## Testing Strategy\n\n### Unit Testing\n\n**Backend (Rust):**\n- Regex Engine: 测试所有内置规则的正确性\n- Privacy Shield: 测试各类 PII 模式的检测准确率\n- Config Manager: 测试配置读写的正确性\n\n```rust\n#[cfg(test)]\nmod tests {\n    #[test]\n    fn test_phone_detection() {\n        let result = scan_pii(\"联系人：张三，手机：13800138000\");\n        assert_eq!(result.items.len(), 1);\n        assert_eq!(result.items[0].pii_type, PIIType::Phone);\n    }\n}\n```\n\n**Frontend (Vue):**\n- Components: 使用 Vitest + Vue Test Utils\n- Store: 测试 Pinia actions 的状态变更\n\n### Integration Testing\n\n- **IPC 通信:** 测试 Tauri commands 的调用与返回\n- **AI Pipeline:** Mock AI 响应，测试完整的 mask -> call -> restore 流程\n- **Hotkey:** 测试快捷键注册、触发、面板显示的完整流程\n\n### End-to-End Testing\n\n使用 Playwright + Tauri Driver:\n\n1. **基础流程:** 快捷键唤起 → 选择规则 → 确认粘贴\n2. **AI 流程:** 输入指令 → 等待响应 → 确认结果\n3. **隐私流程:** 包含 PII 的文本 → 验证脱敏 → 验证还原\n4. **错误恢复:** 模拟网络断开 → 验证错误提示 → 验证重试功能\n\n## File Structure\n\n```\nflow-paste/\n├── src-tauri/\n│   ├── src/\n│   │   ├── main.rs              # Tauri entry point\n│   │   ├── commands/            # Tauri command handlers\n│   │   │   ├── mod.rs\n│   │   │   ├── clipboard.rs\n│   │   │   ├── ai.rs\n│   │   │   └── config.rs\n│   │   ├── clipboard/\n│   │   │   ├── mod.rs\n│   │   │   └── manager.rs\n│   │   ├── hotkey/\n│   │   │   ├── mod.rs\n│   │   │   └── manager.rs\n│   │   ├── ai/\n│   │   │   ├── mod.rs\n│   │   │   ├── openai.rs\n│   │   │   ├── ollama.rs\n│   │   │   └── intent.rs\n│   │   ├── privacy/\n│   │   │   ├── mod.rs\n│   │   │   ├── scanner.rs\n│   │   │   ├── masker.rs\n│   │   │   └── patterns.rs\n│   │   ├── regex/\n│   │   │   ├── mod.rs\n│   │   │   └── rules.rs\n│   │   └── config/\n│   │       ├── mod.rs\n│   │       ├── store.rs\n│   │       └── keychain.rs\n│   ├── Cargo.toml\n│   └── tauri.conf.json\n├── src/\n│   ├── main.ts                  # Vue entry\n│   ├── App.vue\n│   ├── components/\n│   │   ├── FloatingPanel.vue\n│   │   ├── CommandInput.vue\n│   │   ├── Preview.vue\n│   │   ├── ActionChips.vue\n│   │   └── PrivacyIndicator.vue\n│   ├── stores/\n│   │   └── app.ts               # Pinia store\n│   ├── composables/\n│   │   ├── useClipboard.ts\n│   │   ├── useHotkey.ts\n│   │   └── useAI.ts\n│   ├── lib/\n│   │   └── tauri.ts             # IPC wrapper\n│   └── types/\n│       └── index.ts\n├── package.json\n└── vite.config.ts\n```\n",
  "fileStats": {
    "size": 14404,
    "lines": 505,
    "lastModified": "2025-12-18T14:26:25.341Z"
  },
  "comments": []
}