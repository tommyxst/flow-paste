{
  "id": "snapshot_1766068279373_8m360d6dr",
  "approvalId": "approval_1766068174937_em7th3vcq",
  "approvalTitle": "Updated Requirements (REQ-13~17, Security Enhancements)",
  "version": 3,
  "timestamp": "2025-12-18T14:31:19.373Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Requirements Document - FlowPaste (MVP v1.0)\n\n## Introduction\n\nFlowPaste (妙贴) 是一款隐私优先、AI 驱动的智能剪贴板增强工具。核心目标是通过规则引擎和 AI 模型自动处理文本格式，同时通过本地脱敏技术保护用户隐私。\n\n**核心价值：**\n- **Flow (心流):** 减少格式调整时间，保持工作专注\n- **Privacy (隐私):** 敏感数据不出本地，脱敏后处理\n- **Speed (极速):** 本地优先策略，毫秒级响应\n\n## Target Users\n\n- **开发者:** 格式化 JSON/XML，转换代码语言，提取 Log 关键信息\n- **内容创作者:** Markdown 与纯文本互转，润色社交媒体文案\n- **商务人士:** 翻译邮件，整理会议记录，清洗 Excel 数据\n\n---\n\n## Requirements\n\n### REQ-01: Global Hotkey Activation\n\n**User Story:** As a user, I want to invoke FlowPaste using a customizable global hotkey, so that I can quickly access the tool without interrupting my workflow.\n\n#### Acceptance Criteria\n\n1. WHEN user presses `Cmd/Ctrl + Shift + V` THEN system SHALL display the floating panel\n2. IF user has configured a custom hotkey THEN system SHALL use the custom hotkey instead of default\n3. WHEN panel is invoked THEN system SHALL render within 100ms of keypress\n4. WHEN panel is already visible AND user presses hotkey THEN system SHALL close the panel\n5. IF hotkey conflicts with another application THEN system SHALL display notification with guidance to change hotkey\n6. IF hotkey registration fails THEN system SHALL fall back to alternative activation method (tray icon click)\n\n### REQ-02: Clipboard Content Reading\n\n**User Story:** As a user, I want FlowPaste to automatically read my clipboard content when invoked, so that I can immediately see and process my copied text.\n\n#### Acceptance Criteria\n\n1. WHEN panel is invoked THEN system SHALL read current clipboard text content\n2. WHEN clipboard contains text THEN system SHALL display first 3 lines as preview (gray font)\n3. IF clipboard is empty THEN system SHALL display appropriate placeholder message\n4. WHEN clipboard content is read THEN system SHALL NOT modify original clipboard content\n\n### REQ-03: Result Output to Cursor\n\n**User Story:** As a user, I want processed text to be pasted at my cursor position, so that I can seamlessly continue my work.\n\n#### Acceptance Criteria\n\n1. WHEN user confirms result (Enter key) THEN system SHALL paste processed text at cursor position\n2. WHEN text is pasted THEN system SHALL close the panel automatically\n3. IF paste operation fails THEN system SHALL display error message and keep panel open\n4. WHEN pasting THEN system SHALL use keyboard simulation or system API appropriately\n\n### REQ-04: Raw Paste Option\n\n**User Story:** As a user, I want an option to paste without any processing, so that I have a fallback when AI processing is not needed.\n\n#### Acceptance Criteria\n\n1. WHEN user selects \"Raw Paste\" option THEN system SHALL paste original clipboard content unchanged\n2. WHEN user presses Esc THEN system SHALL close panel without pasting\n3. IF processing fails THEN system SHALL offer raw paste as fallback option\n\n### REQ-05: Local Regex Rules (L1 Engine)\n\n**User Story:** As a user, I want built-in text processing rules that work offline, so that I can quickly format text without network dependency.\n\n#### Acceptance Criteria\n\n1. WHEN user selects a local rule THEN system SHALL process text without network request\n2. WHEN local processing occurs THEN system SHALL complete within 50ms\n3. System SHALL provide the following built-in rules:\n   - Remove empty lines\n   - Remove extra whitespace\n   - Add space between CJK and English characters\n   - Convert to plain text\n   - Trim leading/trailing whitespace\n4. WHEN local rule is applied THEN system SHALL show result immediately (no loading state)\n\n### REQ-06: AI Intent Recognition (L2 Engine)\n\n**User Story:** As a user, I want AI to automatically analyze my clipboard content and suggest relevant actions, so that I can process text with minimal effort.\n\n#### Acceptance Criteria\n\n1. WHEN panel is invoked with text THEN system SHALL analyze text type (code/JSON/table/prose)\n2. WHEN analysis completes THEN system SHALL display 1-3 recommended Action Chips\n3. WHEN Action Chips are displayed THEN system SHALL allow selection via number keys (1, 2, 3)\n4. IF AI analysis fails THEN system SHALL show local rules as fallback options\n\n### REQ-07: Natural Language Commands\n\n**User Story:** As a user, I want to describe my formatting needs in natural language, so that I can handle complex transformations without predefined rules.\n\n#### Acceptance Criteria\n\n1. WHEN user types a command (e.g., \"translate to Japanese\") THEN system SHALL process via LLM\n2. WHEN processing THEN system SHALL show streaming output (typewriter effect)\n3. IF command is ambiguous THEN system SHALL use best interpretation based on context\n4. WHEN streaming THEN first token SHALL appear within 1s of submission\n\n### REQ-08: Local Model Support (Ollama)\n\n**User Story:** As a user, I want to use local AI models via Ollama, so that I can process sensitive data without sending it to cloud services.\n\n#### Acceptance Criteria\n\n1. WHEN Ollama is configured THEN system SHALL detect available local models\n2. IF local model is selected THEN system SHALL route all AI requests to local endpoint\n3. WHEN using local model THEN system SHALL display \"Local\" indicator in UI\n4. IF Ollama connection fails THEN system SHALL display clear error message\n\n### REQ-09: Cloud Model Support (OpenAI Compatible)\n\n**User Story:** As a user, I want to connect to cloud AI services using my own API keys, so that I can use powerful models like GPT-4 or Claude.\n\n#### Acceptance Criteria\n\n1. WHEN user provides API key and base URL THEN system SHALL validate connection\n2. WHEN cloud API is configured THEN system SHALL store credentials securely (system keychain)\n3. IF API call fails THEN system SHALL display error with retry option\n4. System SHALL support OpenAI-compatible APIs (OpenAI, DeepSeek, Claude via compatible endpoint)\n5. WHEN storing API keys THEN system SHALL use Windows Credential Locker / macOS Keychain\n6. WHEN configuring base URL THEN system SHALL enforce HTTPS protocol (reject http://)\n7. WHEN validating base URL THEN system SHALL verify domain format to prevent SSRF attacks\n\n### REQ-10: Sensitive Information Detection\n\n**User Story:** As a user, I want the system to detect sensitive information before sending to cloud AI, so that my private data stays protected.\n\n#### Acceptance Criteria\n\n1. WHEN text is about to be sent to cloud AI THEN system SHALL scan for sensitive patterns\n2. System SHALL detect the following PII types:\n   - Phone numbers (CN mobile format)\n   - Email addresses\n   - ID card numbers (CN format)\n   - Bank card numbers\n   - IP addresses\n   - API keys (sk-... pattern)\n3. WHEN sensitive data is detected THEN system SHALL display count in Privacy Shield indicator\n4. IF no cloud AI is used (local only) THEN detection step SHALL be skipped\n\n### REQ-11: Data Masking and Restoration\n\n**User Story:** As a user, I want sensitive data to be masked before AI processing and restored after, so that AI never sees my real private information.\n\n#### Acceptance Criteria\n\n1. WHEN sensitive data is detected THEN system SHALL replace with placeholders `{{TYPE_ID}}`\n2. WHEN AI response is received THEN system SHALL restore placeholders to original values\n3. WHEN masking THEN system SHALL maintain mapping table in memory only (never persisted)\n4. IF restoration fails THEN system SHALL display warning and show raw AI response\n\n### REQ-12: Privacy Status Indicator\n\n**User Story:** As a user, I want to see clear visual feedback about privacy status, so that I know whether my data is being sent to cloud services.\n\n#### Acceptance Criteria\n\n1. WHEN panel is displayed THEN system SHALL show Privacy Shield icon\n2. IF operation is local-only THEN shield SHALL be green with \"Local\" tooltip\n3. IF cloud API is used AND data is masked THEN shield SHALL show masked item count\n4. IF cloud API is used AND no sensitive data THEN shield SHALL indicate \"Cloud - No PII detected\"\n\n### REQ-13: Input Length Limits\n\n**User Story:** As a user, I want the system to handle large clipboard content gracefully, so that I don't experience crashes or excessive AI token consumption.\n\n#### Acceptance Criteria\n\n1. WHEN clipboard content exceeds 10,000 characters THEN system SHALL truncate for AI processing with notification\n2. WHEN clipboard content exceeds 50,000 characters THEN system SHALL reject AI processing and suggest local rules\n3. WHEN content is truncated THEN system SHALL display warning with original/truncated length\n4. System SHALL enforce maximum 4,000 characters per AI request to prevent token exhaustion\n5. WHEN large content is processed THEN system SHALL use chunked streaming to maintain UI responsiveness\n\n### REQ-14: Non-text Clipboard Handling\n\n**User Story:** As a user, I want clear feedback when I copy non-text content, so that I understand why AI processing is unavailable.\n\n#### Acceptance Criteria\n\n1. IF clipboard contains image/binary data THEN system SHALL display \"Text content only\" message\n2. IF clipboard contains rich text (HTML/RTF) THEN system SHALL extract plain text for processing\n3. WHEN non-text content is detected THEN system SHALL still allow panel dismissal via Esc\n4. System SHALL detect clipboard content type before attempting to read text\n\n### REQ-15: System Permission Handling\n\n**User Story:** As a user, I want the system to guide me through required permissions setup, so that all features work correctly on my OS.\n\n#### Acceptance Criteria\n\n1. WHEN app first launches on macOS THEN system SHALL check Accessibility permission status\n2. IF Accessibility permission is missing THEN system SHALL display setup guide with System Preferences link\n3. WHEN clipboard access is denied THEN system SHALL display clear error with permission instructions\n4. IF keyboard simulation fails due to permissions THEN system SHALL fallback to clipboard-only paste\n5. System SHALL cache permission status and re-check only when operations fail\n\n### REQ-16: Cancel and Undo Operations\n\n**User Story:** As a user, I want to cancel ongoing AI processing and undo accidental pastes, so that I maintain control over my workflow.\n\n#### Acceptance Criteria\n\n1. WHEN AI is streaming THEN system SHALL display cancel button (or Esc to cancel)\n2. WHEN user cancels AI processing THEN system SHALL abort request and return to preview state\n3. WHEN paste completes THEN system SHALL support Cmd/Ctrl+Z to undo in target application\n4. IF AI request times out (>30s) THEN system SHALL auto-cancel and display timeout message\n5. WHEN canceling THEN system SHALL preserve original clipboard content\n\n### REQ-17: Window Focus Behavior\n\n**User Story:** As a user, I want the panel to behave predictably when I interact with other applications, so that my workflow is not disrupted.\n\n#### Acceptance Criteria\n\n1. WHEN panel loses focus (click outside) THEN system SHALL automatically hide the panel\n2. IF AI processing is in progress when focus lost THEN system SHALL continue processing in background\n3. WHEN processing completes in background THEN system SHALL notify user via system notification\n4. WHEN panel is hidden THEN system SHALL preserve current state for next invocation\n5. System SHALL debounce rapid show/hide to prevent flicker (100ms minimum interval)\n\n---\n\n## Non-Functional Requirements\n\n### Code Architecture and Modularity\n\n- **Single Responsibility Principle:** Each module handles one concern (clipboard, AI, masking, UI)\n- **Modular Design:** Clear separation between Tauri backend (Rust) and frontend (React/Vue)\n- **Dependency Management:** Minimize coupling between processing engines\n- **Clear Interfaces:** Well-defined IPC contracts between Rust and JS layers\n\n### Performance\n\n- **Invocation Speed:** Panel must render within 100ms of hotkey press\n- **Memory Footprint:** Static memory usage below 50MB\n- **Local Processing:** All regex operations must complete within 50ms\n- **Streaming Response:** First AI token must appear within 1s of request\n\n### Security\n\n- **Credential Storage:** API keys must use OS-level secure storage (Keychain/Credential Locker)\n- **No Plain Text Keys:** API keys must never be stored in config files or databases\n- **Memory-Only Mapping:** PII mapping tables must exist only in runtime memory\n- **No Content Logging:** User clipboard content must never be logged or persisted\n\n### Reliability\n\n- **Graceful Degradation:** If AI fails, local rules must remain available\n- **Error Recovery:** UI must never freeze; errors display inline with dismiss option\n- **Connection Resilience:** Failed API calls should offer retry without losing user input\n\n### Usability\n\n- **Keyboard-First Design:** All operations must be achievable without mouse\n- **Visual Feedback:** All state changes must have immediate visual indication\n- **System Theme Integration:** UI must follow system dark/light mode preference\n- **Minimal Learning Curve:** Core workflow (hotkey → select → paste) must be intuitive\n",
  "fileStats": {
    "size": 13147,
    "lines": 265,
    "lastModified": "2025-12-18T14:25:59.008Z"
  },
  "comments": []
}